{
  "feature": "Page Listing Access Control Fix",
  "created": "2026-01-16",
  "parent_task_id": "page-listing-access-fix",
  "research": {
    "similar_patterns": [
      "src/lib/server/persistence/areas-postgres.ts - findAllAccessible() uses CTE pattern",
      "src/lib/server/persistence/page-sharing-postgres.ts - canAccessPage() algorithm"
    ],
    "related_commits": [],
    "docs_reviewed": [
      "docs/features/PAGE_LISTING_ACCESS_FIX.md",
      "docs/database/ENTITY_MODEL.md",
      "docs/features/page-sharing-permissions-audit.md"
    ],
    "problem_statement": "When pages have visibility='area', area members cannot see them in findAll() list because query only checks user_id. findById() works because it uses canAccessPage() for full access control."
  },
  "stories": [
    {
      "id": "US-001",
      "title": "Update findAll() with CTE-based access control",
      "description": "As an area member, I want to see pages shared with my area in the page list so that I can access all pages I have permission to view.",
      "status": "completed",
      "dependencies": [],
      "acceptance_criteria": [
        "Create buildAccessiblePagesQuery() helper that returns CTE SQL for accessible page IDs",
        "CTE includes 5 access paths: owner, user_share, group_share, area_visibility, space_visibility",
        "Update findAll() to use the CTE instead of simple user_id check",
        "Owner still sees their own pages (Path 1 in UNION)",
        "Area member sees area-visible pages in areas they can access",
        "User with direct share sees private pages shared with them",
        "User in shared group sees private pages via group membership",
        "Space owner sees space-visible pages",
        "User does NOT see pages in areas they cannot access",
        "Filter by areaId still works correctly",
        "Filter by pageType still works correctly",
        "Filter by taskId still works correctly",
        "Deleted pages (deleted_at IS NOT NULL) are excluded",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-002",
      "title": "Update search() with access control",
      "description": "As a user, I want search to only return pages I can access so that search results respect sharing permissions.",
      "status": "completed",
      "dependencies": [
        "US-001"
      ],
      "acceptance_criteria": [
        "Reuse buildAccessiblePagesQuery() helper from US-001",
        "search() filters results through accessible pages CTE",
        "Search only returns pages user can access",
        "Search within specific area respects access control",
        "Full-text search functionality still works correctly",
        "Search ranking is preserved",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-003",
      "title": "Update count() with access control",
      "description": "As a user, I want page counts to reflect only pages I can access so that UI counters are accurate.",
      "status": "pending",
      "dependencies": [
        "US-001"
      ],
      "acceptance_criteria": [
        "Reuse buildAccessiblePagesQuery() helper from US-001",
        "count() filters through accessible pages CTE",
        "Count returns accurate number of accessible pages",
        "Count with areaId filter is accurate",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-004",
      "title": "Manual testing and verification",
      "description": "As a developer, I want to verify all access control scenarios work correctly so that the fix is complete.",
      "status": "pending",
      "dependencies": [
        "US-001",
        "US-002",
        "US-003"
      ],
      "acceptance_criteria": [
        "Test: User A creates page, shares with area -> User B (area member) sees it in list",
        "Test: User A creates private page, shares with User B -> User B sees it in list",
        "Test: User A creates private page -> User B does NOT see it in list",
        "Test: User A creates page in restricted area -> User B (non-member) does NOT see it",
        "Test: Owner sees their own pages regardless of visibility setting",
        "Test: Deleted pages are not shown to anyone",
        "Test: Search respects all access control rules",
        "Test: Count reflects accessible pages only",
        "All tests pass manually in browser"
      ]
    }
  ]
}

{
  "feature": "Temporal Awareness",
  "created": "2026-01-16",
  "parent_task_id": "temporal-awareness",
  "research": {
    "similar_patterns": [
      "src/lib/config/system-prompts.ts - getSystemPromptLayers() function and PromptLayer interface",
      "src/lib/types/user.ts - UserPreferences interface pattern",
      "src/routes/api/user/preferences/+server.ts - validation pattern for preferences (theme, homePage)",
      "src/routes/+layout.svelte - onMount pattern for client-side detection (theme sync)"
    ],
    "docs_reviewed": [
      "docs/features/TEMPORAL_AWARENESS.md",
      "CLAUDE.md"
    ],
    "decisions_made": [
      {
        "question": "Where to store timezone?",
        "decision": "In UserPreferences JSON field (not a schema change)",
        "rationale": "Follows existing pattern for theme and homePage; no migration needed"
      },
      {
        "question": "Default timezone",
        "decision": "Africa/Johannesburg (SAST)",
        "rationale": "Current user base is South Africa; spec explicitly states this"
      },
      {
        "question": "Cache Layer 0?",
        "decision": "shouldCache: false",
        "rationale": "Temporal context changes daily; small (~50 tokens) so cache miss negligible"
      }
    ]
  },
  "stories": [
    {
      "id": "US-001",
      "title": "Create getTemporalContext() function in system-prompts.ts",
      "description": "As a developer, I need a function that generates temporal context strings with current date and timezone for injection into system prompts.",
      "status": "completed",
      "dependencies": [],
      "acceptance_criteria": [
        "Function getTemporalContext(timezone?: string) exists in src/lib/config/system-prompts.ts",
        "Returns date formatted as 'Thursday, January 16, 2026' with day of week",
        "Returns timezone display name (e.g., 'South Africa Standard Time')",
        "Output wrapped in <temporal_context> XML tags",
        "Defaults to 'Africa/Johannesburg' when no timezone provided",
        "Function is exported from the module",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-002",
      "title": "Inject temporal context as Layer 0 in getSystemPromptLayers()",
      "description": "As a user, I want the AI to know the current date and my timezone so it can answer date-relative questions accurately.",
      "status": "completed",
      "dependencies": [
        "US-001"
      ],
      "acceptance_criteria": [
        "getSystemPromptLayers() accepts new timezone option: options.timezone?: string",
        "Temporal layer inserted as first layer (Layer 0) before platform prompt",
        "Temporal layer has name: 'temporal', shouldCache: false",
        "Platform prompt becomes Layer 1 (shifts all subsequent layers)",
        "Temporal context uses timezone from options, falls back to 'Africa/Johannesburg'",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-003",
      "title": "Add timezone field to UserPreferences type",
      "description": "As a developer, I need the UserPreferences type to include timezone so it can be stored and retrieved from the database.",
      "status": "completed",
      "dependencies": [],
      "acceptance_criteria": [
        "UserPreferences interface in src/lib/types/user.ts includes timezone?: string",
        "Type uses IANA timezone format (e.g., 'Africa/Johannesburg', 'America/New_York')",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-004",
      "title": "Add timezone validation to preferences API endpoint",
      "description": "As a developer, I need the preferences API to accept and validate timezone updates.",
      "status": "completed",
      "dependencies": [
        "US-003"
      ],
      "acceptance_criteria": [
        "validateTimezone() function added to src/routes/api/user/preferences/+server.ts",
        "Validates timezone is a non-empty string (Intl API validates at runtime)",
        "PATCH handler accepts body.timezone and calls validateTimezone()",
        "Valid timezone added to updates object",
        "Invalid timezone returns 400 with validation_error",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-005",
      "title": "Detect and sync timezone on app load",
      "description": "As a user, I want my timezone automatically detected and saved so the AI knows my location without manual configuration.",
      "status": "completed",
      "dependencies": [
        "US-004"
      ],
      "acceptance_criteria": [
        "Timezone detection code added to src/routes/+layout.svelte onMount()",
        "Uses Intl.DateTimeFormat().resolvedOptions().timeZone for detection",
        "Only updates if detected timezone differs from stored preference",
        "Calls PATCH /api/user/preferences with { timezone: detectedTimezone }",
        "Updates userStore.preferences with new timezone",
        "Silent operation - no toast or UI feedback unless error",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-006",
      "title": "Pass timezone to chat API and prompt builder",
      "description": "As a user, I want my timezone used in every AI conversation so responses are temporally accurate.",
      "status": "pending",
      "dependencies": [
        "US-002",
        "US-005"
      ],
      "acceptance_criteria": [
        "Chat API endpoint reads timezone from session or user preferences",
        "Falls back to 'Africa/Johannesburg' if not set",
        "Passes timezone to getSystemPromptLayers() call",
        "Temporal context appears in system prompt sent to LLM",
        "npm run check passes",
        "npm run lint passes",
        "Manual verification: Ask 'What is today's date?' and receive correct answer",
        "Manual verification: Ask 'What day of the week is it?' and receive correct answer"
      ]
    },
    {
      "id": "US-007",
      "title": "Add timezone selector to Settings UI (Optional Phase 3)",
      "description": "As a user, I want to manually override my detected timezone in Settings if the auto-detection is wrong.",
      "status": "pending",
      "dependencies": [
        "US-005"
      ],
      "acceptance_criteria": [
        "Timezone dropdown added to Settings > General page (src/lib/components/settings/SettingsGeneral.svelte or similar)",
        "Shows common timezones: Africa/Johannesburg, Europe/London, America/New_York, America/Los_Angeles, Asia/Tokyo, etc.",
        "Shows auto-detected timezone as help text",
        "Selecting new timezone calls PATCH /api/user/preferences",
        "Updates local state after successful save",
        "npm run check passes",
        "npm run lint passes"
      ]
    }
  ]
}

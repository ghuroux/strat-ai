{
  "feature": "Phase C: Navigation Redesign with Space Pinning",
  "created": "2026-01-15",
  "parent_task_id": "phase-c-nav-pinning",
  "research": {
    "similar_patterns": [
      "src/lib/server/persistence/spaces-postgres.ts",
      "src/lib/server/persistence/space-memberships-postgres.ts",
      "src/lib/stores/spaces.svelte.ts",
      "src/lib/components/layout/Header.svelte",
      "src/lib/utils/space-display.ts"
    ],
    "docs_reviewed": [
      "docs/database/ENTITY_MODEL.md",
      "docs/features/phase-c-nav-pinning.md",
      "CLAUDE.md"
    ],
    "decisions_made": [
      {
        "question": "Migration number",
        "decision": "Use 034 instead of spec's 032",
        "rationale": "Migrations 032 and 033 already exist in codebase"
      },
      {
        "question": "Auto-pin when at max 6",
        "decision": "Skip auto-pin when at max",
        "rationale": "Avoid confusion by not auto-unpinning user choices; new spaces start unpinned if at max"
      }
    ]
  },
  "stories": [
    {
      "id": "US-001",
      "title": "Create space pinning database migration",
      "description": "As a developer, I need the database schema changes to support space pinning (is_pinned columns on spaces and space_memberships tables).",
      "status": "completed",
      "dependencies": [],
      "acceptance_criteria": [
        "Migration 034-space-pinning.sql exists",
        "spaces table has is_pinned BOOLEAN column with DEFAULT true",
        "space_memberships table has is_pinned BOOLEAN column with DEFAULT false",
        "space_memberships table has display_alias VARCHAR(100) column (optional feature)",
        "Index idx_spaces_pinned created on spaces(user_id, is_pinned) WHERE deleted_at IS NULL AND is_pinned = true",
        "Index idx_space_memberships_pinned created on space_memberships(user_id, is_pinned) WHERE is_pinned = true",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-002",
      "title": "Update Space and SpaceMembership types with pinning fields",
      "description": "As a developer, I need the TypeScript types updated to include isPinned and displayAlias fields for both owned and invited spaces.",
      "status": "completed",
      "dependencies": ["US-001"],
      "acceptance_criteria": [
        "Space interface in src/lib/types/spaces.ts includes isPinned?: boolean",
        "SpaceRow interface includes isPinned: boolean | null",
        "rowToSpace converter handles isPinned field correctly",
        "SpaceMembership interface in src/lib/types/space-memberships.ts includes isPinned?: boolean and displayAlias?: string | null",
        "SpaceMembershipRow interface includes isPinned: boolean | null and displayAlias: string | null",
        "rowToSpaceMembership converter handles new fields",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-003",
      "title": "Add pin/unpin repository methods to spaces-postgres.ts",
      "description": "As a developer, I need repository methods to pin/unpin spaces and query pinned count for enforcement.",
      "status": "completed",
      "dependencies": ["US-002"],
      "acceptance_criteria": [
        "pinSpace(spaceId, userId) method added - updates spaces.is_pinned for owned, space_memberships.is_pinned for invited",
        "unpinSpace(spaceId, userId) method added - same pattern as pin",
        "getPinnedCount(userId) method added - returns count of pinned owned + invited spaces",
        "findAllAccessible query updated to include isPinned field in results",
        "Uses camelCase access pattern (row.isPinned not row.is_pinned)",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-004",
      "title": "Create pin/unpin API endpoints",
      "description": "As a developer, I need API endpoints to pin and unpin spaces with max 6 enforcement.",
      "status": "completed",
      "dependencies": ["US-003"],
      "acceptance_criteria": [
        "POST /api/spaces/[id]/pin endpoint created in src/routes/api/spaces/[id]/pin/+server.ts",
        "POST /api/spaces/[id]/unpin endpoint created in src/routes/api/spaces/[id]/unpin/+server.ts",
        "Pin endpoint checks getPinnedCount < 6 before pinning",
        "Pin endpoint returns 400 with error message when at max",
        "Both endpoints verify user has access to the space",
        "Both endpoints return updated space data",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-005",
      "title": "Update spaces store with pin/unpin actions and derived states",
      "description": "As a developer, I need the spaces store to support pinning state management with derived states for pinned/unpinned spaces.",
      "status": "completed",
      "dependencies": ["US-004"],
      "acceptance_criteria": [
        "getPinnedSpaces() derived state returns spaces where isPinned=true, max 6",
        "getUnpinnedOwnedSpaces() derived state returns unpinned owned spaces",
        "getUnpinnedSharedSpaces() derived state returns unpinned shared spaces (userId != currentUserId)",
        "pinSpace(spaceId) async action calls API and updates local state",
        "unpinSpace(spaceId) async action calls API and updates local state",
        "Pin action checks count < 6 before calling API, sets error if at max",
        "Stores updated when API calls succeed",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-006",
      "title": "Create AllSpacesDropdown component",
      "description": "As a user, I want a dropdown showing all my spaces organized by section (Pinned, Your Spaces, Shared With You) so I can access any space and manage pinning.",
      "status": "completed",
      "dependencies": ["US-005"],
      "acceptance_criteria": [
        "AllSpacesDropdown.svelte component created in src/lib/components/spaces/",
        "Shows PINNED TO NAV section with star icon and X (unpin) buttons",
        "Shows YOUR SPACES section with unpinned owned spaces and pin buttons",
        "Shows SHARED WITH YOU section with unpinned invited spaces and pin buttons",
        "Shows footer with Maximum 6 pinned and remaining count",
        "Pin buttons disabled with tooltip when at max 6",
        "Uses getSpaceDisplayName() for space names with owner context",
        "Click outside closes dropdown",
        "Escape key closes dropdown",
        "Smooth open/close animation",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-007",
      "title": "Create SpaceNavTabs component",
      "description": "As a user, I want to see my pinned spaces as tabs in the nav bar with quick access to all spaces via dropdown.",
      "status": "completed",
      "dependencies": ["US-006"],
      "acceptance_criteria": [
        "SpaceNavTabs.svelte component created in src/lib/components/spaces/",
        "Shows pinned spaces as tab links with active state",
        "Right-click on tab shows context menu with Unpin from navigation option",
        "Integrates AllSpacesDropdown as the All button",
        "Uses getSpaceDisplayName() for space names",
        "Tab styling matches existing space-nav-item pattern from Header.svelte",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-008",
      "title": "Integrate SpaceNavTabs into Header component",
      "description": "As a user, I want the Header to show pinned spaces with the All dropdown instead of listing all spaces as tabs.",
      "status": "completed",
      "dependencies": ["US-007"],
      "acceptance_criteria": [
        "Header.svelte updated to use SpaceNavTabs instead of current space tab loop",
        "Existing system/custom space loops replaced with single SpaceNavTabs component",
        "Space add button moved to AllSpacesDropdown or kept in header (design decision)",
        "Mobile navigation updated appropriately",
        "Main Chat and Arena links remain unchanged",
        "npm run check passes",
        "npm run lint passes",
        "Manual verification: pinned spaces appear as tabs",
        "Manual verification: All button opens dropdown",
        "Manual verification: pin/unpin works correctly"
      ]
    },
    {
      "id": "US-009",
      "title": "Implement auto-pin rules on space creation and org join",
      "description": "As a user, I want new spaces I create and org spaces I join to be auto-pinned (if under max 6) so they appear in my nav immediately.",
      "status": "completed",
      "dependencies": ["US-003"],
      "acceptance_criteria": [
        "Space creation in spaces-postgres.ts sets is_pinned=true if user has < 6 pinned",
        "Org space auto-pins when user joins org (if under max)",
        "Invited spaces start with is_pinned=false in space_memberships",
        "Auto-pin skips if user already at max 6 (no auto-unpin)",
        "npm run check passes",
        "npm run lint passes"
      ]
    },
    {
      "id": "US-010",
      "title": "Handle edge cases and cleanup",
      "description": "As a developer, I need to ensure edge cases are handled: 0 spaces, deleted pinned spaces, leaving shared spaces.",
      "status": "completed",
      "dependencies": ["US-008", "US-009"],
      "acceptance_criteria": [
        "User with 0 spaces sees empty dropdown with helpful message",
        "User with 1-6 spaces: all auto-pinned by default, dropdown still accessible",
        "Deleting a pinned space removes it from nav immediately",
        "Leaving a shared space removes it from nav if pinned",
        "Dropdown footer count updates correctly after pin/unpin",
        "npm run check passes",
        "npm run lint passes",
        "Manual verification of all edge cases listed"
      ]
    }
  ]
}
